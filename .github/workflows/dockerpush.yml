name: Publish Docker image

on:
  push:
    branches:
      - master

jobs:
  build-images:
    name: Push Docker image to Docker Hub
    runs-on: ubuntu-latest
    env:
      JWT_EXPIRE: ${{ secrets.JWT_EXPIRE }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      PORT: ${{ secrets.PORT }}
      PORT_1: ${{ secrets.PORT_1 }}
      DB_URI: ${{ secrets.DB_URI }}
      DB_NAME: ${{ secrets.DB_NAME }}
      COOKIE_EXPIRE: ${{ secrets.COOKIE_EXPIRE }}
      SMPT_SERVICE: ${{ secrets.SMPT_SERVICE }}
      SMPT_HOST: ${{ secrets.SMPT_HOST }}
      SMPT_PORT: ${{ secrets.SMPT_PORT }}
      SMPT_MAIL: ${{ secrets.SMPT_MAIL }}
      SMPT_PASSWORD: ${{ secrets.SMPT_PASSWORD }}
      CLOUDINARY_NAME: ${{ secrets.CLOUDINARY_NAME }}
      CLOUDINARY_APIKEY: ${{ secrets.CLOUDINARY_APIKEY }}
      CLOUDINARY_SECRET: ${{ secrets.CLOUDINARY_SECRET }}
    steps:
      # Log into GitHub Container Registry
      - name: Log into registry
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      # Check out the repo
      - name: Checkout
        uses: actions/checkout@v2
      # Build the images
      - name: Build the docker-compose stack
        run: |
          export JWT_EXPIRE=$JWT_EXPIRE
          export JWT_SECRET=$JWT_SECRET
          export PORT=$PORT
          export PORT_1=$PORT_1
          export DB_URI=$DB_URI
          export DB_NAME=$DB_NAME
          export COOKIE_EXPIRE=$COOKIE_EXPIRE
          export SMPT_SERVICE=$SMPT_SERVICE
          export SMPT_HOST=$SMPT_HOST
          export SMPT_PORT=$SMPT_PORT
          export SMPT_MAIL=$SMPT_MAIL
          export SMPT_PASSWORD=$SMPT_PASSWORD
          export CLOUDINARY_NAME=$CLOUDINARY_NAME
          export CLOUDINARY_APIKEY=$CLOUDINARY_APIKEY
          export CLOUDINARY_SECRET=$CLOUDINARY_SECRET
          docker-compose -f docker-compose.yml build
      # List images
      - name: List images
        run: docker images
      # Push images to GitHub Container Registry
      - name: Push images to GitHub Container Registry
        run: docker-compose -f docker-compose.yml push --ignore-push-failures
      # Log in to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v1
        with:
          registry: docker.io
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@98669ae865ea3cffbcbaa878cf57c20bbf1c6c38
        with:
          images: lekejosh/api1
      # Build and push Docker image to Docker Hub
      - name: Build and push Docker images
        uses: docker/compose-action@v2
        with:
          compose-file: docker-compose.yml
          services: mongo_db,api
          context: .
          push: true
          tags: |
              mongo:latest
              lekejosh/api:latest
             
